---
title: "前端性能优化小结"
date: 2019-04-12
categories: JavaScript
description: 从网页渲染过程、网页交互以及Vue应用优化三个角度对性能优化做一个小结。
tags: 
- JavaScript
- 优化

---

### 一、页面加载及渲染流程优化

##### 浏览器渲染流程

首先看看浏览器渲染流程

> 1. 解析HTML文件，构建DOM树，同时浏览器主线程负责下载CSS文件。
> 2. CSS文件下载完成，解析CSS文件成树形的数据结构，然后结合DOM树合并成RenderObject树。
> 3. 布局RenderObject树，负责RenderObject树中的元素的尺寸，位置等。
> 4. 绘制RenderObject树，绘制页面的像素信息
> 5. 浏览器主进程将默认的涂层和复合涂层交给GPU进程，GPU进册亨合成各个涂层。

在这里，我们可以修改减少这三种可变因素。

* 关键资源的数量：可能阻止网页首次渲染速度
* 关键路径长度：获取所有关键资源所需的往返次数或总时间

<!--more-->

##### 优化DOM

* 删除不必要的代码注释空格等，最小化文件。
* 利用gzip压缩文件。

##### 优化CSSOM

虽然css加载不会阻塞DOM解析，但是RenderTree依赖于DOM Tree和CSSOM Tree的，所以他必须等待CSSOM Tree构建完成，也就是css资源加载完成才能开始渲染。因此，CSS加载会阻塞DOM的渲染。

* 减少关键CSS元素数量
* 当声明样式表的时候，关注媒体查询的类型。

##### 优化js

当浏览器遇到script标签时，会阻止解析器继续工作，直到CSSOM构建完毕。js才能继续运行。

* async：添加后，浏览器遇到会继续解析DOM，同时脚本也不会背CSSOM阻止。
* defer：与async区别在于，脚本需要等到文档解析后（DOMContentload事件前）执行，而async允许脚本在文档解析时位于后台进行。
* 当脚本不会修改DOM或CSSOM时，推荐使用async。

> 当浏览器遇到script脚本时
>
> 1、没有async或者defer，浏览器会立即加载并执行脚本，不等待后续载入的文档元素。
>
> 2、有async，加载和渲染后续文档元素的过程将和script的加载、执行并行进行（异步）；
>
> 3、有defer，加载后续元素的过程将和script的加载并行进行（异步，但是script的执行要在所有元素解析完成之后，DOMContentloaded事件触发之前）。

#### 浏览器回流和重汇

回流并将引起重绘，但重绘不一定引起回流。

##### 重绘

当页面元素的样式改变并不影响他的位置的时候。（比如color，background-color），浏览器会将新样式赋予给元素并重新绘制，这个过程叫重绘。

##### 回流

当Render Tree中部分或者全部元素的尺寸、结构、或者某些属性发生改变时，浏览器重新渲染部分或者全部文档的过程叫回流。

> 例如：
>
> * 页面首次渲染
> * 浏览器窗口大小变化
> * 元素字体大小变化
> * 添加或者删除可见的DOM元素
> * 激活CSS伪累（:hover）
> * 一些常用的属性方法：clientWidth，clientHeight、clientTop，scrollTo

##### 性能影响

有时候仅仅一个单一元素的回流，也会导致他的父元素产生重绘。现在的浏览器大都会对频繁的回流或重回操作进行优化：他们维护一个队列，将所有引起回流、重绘的操作放入队列中，如果队列任务数量或者时间间隔到达一个阈值时，清空队列，进行一次批处理。这样就能将多次回流变成一次。

当访问特定属性（clientWidth、offsetWidth等），因为队列中可能存在影响到这些属性的操作，浏览器为了确保你拿到的是精确的数值，会强制清空队列。

##### 如何避免/优化

###### CSS

* 避免使用table布局
* 避免使用多层内连样式
* 避免css表达式

###### js

* 避免频繁的样式操作，最好一次性重写style属性，或者将样式列表定义为class并一次性更改class属性。
* 避免频繁操作DOM，如果有需要可以创建一个documentFragment，在它上面应用所有DOM操作，然后添加到文档中去。
* display：none
* 复杂动画的元素绝对定位，使他脱离文档流。



##### 图片懒加载

img标签指向小图或者src为空，然后监听滚动时间，把即将看到的图片src修改为真实src



##### 事件委托

会开专页写。利用事件冒泡将云本需要绑定在子元素的响应事件委托给父元素。



### 二、渲染完成后的页面交互优化

#### 防抖节流

会开专页



### 三、vue中的优化

已开专页

### 四、其他

* webpack模块打包和代码压缩
* cdn加速
* 按需加载资源
* 负载均衡
* service workers
* 图片编码优化，svg、字体图标

